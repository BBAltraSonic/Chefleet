name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

env:
  FLUTTER_VERSION: '3.16.0'
  NODE_VERSION: '18'

jobs:
  # Quality checks before release
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Get Node.js dependencies
        run: |
          if [ -d "functions" ]; then
            cd functions
            npm ci
            cd ..
          fi

      - name: Analyze Flutter code
        run: flutter analyze --fatal-infos

      - name: Run Flutter tests
        run: flutter test --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info

      - name: Run Edge Functions tests
        run: |
          if [ -d "functions" ]; then
            cd functions
            npm test
            cd ..
          fi

      - name: Check for security vulnerabilities
        run: |
          if [ -d "functions" ]; then
            cd functions
            npm audit --audit-level=moderate
            cd ..
          fi

  # Build and test apps
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: quality-checks
    strategy:
      matrix:
        platform: [android, web]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build for ${{ matrix.platform }}
        run: |
          case "${{ matrix.platform }}" in
            android)
              flutter build apk --release
              flutter build appbundle --release
              ;;
            web)
              flutter build web --release
              ;;
          esac

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.platform }}-build
          path: |
            build/app/outputs/flutter-apk/
            build/web/
            build/app/outputs/bundle/

  # Semantic release
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [quality-checks, build-and-test]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install semantic-release
        run: |
          npm install -g semantic-release
          npm install -g @semantic-release/changelog
          npm install -g @semantic-release/git

      - name: Run semantic release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: semantic-release

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: semantic-release
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v3

      - name: Generate changelog
        id: changelog
        run: |
          # Extract version from tag or use a default
          VERSION="${GITHUB_REF#refs/tags/}"
          if [[ "$VERSION" == "$GITHUB_REF" ]]; then
            VERSION="latest"
          fi

          # Generate changelog from conventional commits
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s (%h)" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.changelog.outputs.version }}
          release_name: Chefleet ${{ steps.changelog.outputs.version }}
          body: |
            ## Changes in this release

            ${{ steps.changelog.outputs.CHANGELOG }}

            ### Downloads

            - **Android APK**: Available in the artifacts below
            - **Android App Bundle**: Available in the artifacts below
            - **Web Build**: Available in the artifacts below

            ### Installation

            #### Android
            1. Download the APK file from the artifacts
            2. Enable "Unknown sources" in device settings
            3. Install the APK

            #### Web
            1. Download the web build
            2. Serve with a web server or deploy to hosting

            ---

            Built with ‚ù§Ô∏è by the Chefleet team
          draft: false
          prerelease: false

      - name: Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./android-build/app-release.apk
          asset_name: chefleet-android.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload App Bundle
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./android-build/app-release.aab
          asset_name: chefleet-android.aab
          asset_content_type: application/octet-stream

  # Deploy to staging environments
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: create-release
    if: success()
    strategy:
      matrix:
        environment: [staging-db, staging-functions]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy to ${{ matrix.environment }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROJECT_ID: ${{ secrets.STAGING_PROJECT_ID }}
        run: |
          case "${{ matrix.environment }}" in
            staging-db)
              supabase db push --linked
              ;;
            staging-functions)
              if [ -d "functions" ]; then
                supabase functions deploy --linked
              fi
              ;;
          esac

  # Notify team of release
  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [create-release, deploy-staging]
    if: always() && (needs.create-release.result == 'success' || needs.deploy-staging.result == 'success')
    steps:
      - name: Get release info
        id: release
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          if [[ "$VERSION" == "$GITHUB_REF" ]]; then
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "sha=$GITHUB_SHA" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#releases'
          text: |
            üéâ New Chefleet Release Available!

            Version: ${{ steps.release.outputs.version }}
            Commit: ${{ steps.release.outputs.sha }}

            Download from GitHub releases: https://github.com/${{ github.repository }}/releases

            Staging environments have been updated.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Send failure notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#releases'
          text: |
            ‚ùå Release failed for Chefleet!

            Version: ${{ steps.release.outputs.version }}
            Commit: ${{ steps.release.outputs.sha }}

            Please check the GitHub Actions logs for details.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}